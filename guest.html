<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🐾방명록🐾</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <link rel="stylesheet" href="guest.css" />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        doc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyC0ZJ1e-znOrvP4dmlZ53end6N6A0OaUm8",
        authDomain: "introteam-6a680.firebaseapp.com",
        projectId: "introteam-6a680",
        storageBucket: "introteam-6a680.appspot.com",
        messagingSenderId: "284189308059",
        appId: "1:284189308059:web:a48130e6f4868ac63b823e",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let dateDesc = query(collection(db, "guest"), orderBy("date", "desc"));
      let docs = await getDocs(dateDesc);
      docs.forEach((doc) => {
        let row = doc.data();
        let writer = row["writer"];
        let content = row["content"];
        let password = row["password"];

        let id = doc.id;

        //data-id 추가하기
        let temp_html = `
        <div class="content1" >
        <h2 class="content2">
          <div class="left">${writer}</div>
          <div class="right">${content}</div>
        </h2>
        <button
          type="button"
          class="update-btn"
          data-id="${id}"
          data-bs-toggle="modal"
          data-bs-target="#updateModal"
        >
          수정
        </button>
        <button
          type="button"
          class="delete-btn"
          data-id="${id}"
          data-bs-toggle="modal"
          data-bs-target="#deleteModal"
          >
          삭제
          </button>
      </div>
        `;
        $("#list").append(temp_html);
      });

      $(".update-btn").click(async function () {
        let id = this.dataset["id"];
        let data = await getDoc(doc(db, "guest", id));
        console.log(data.data());

        let writer = data.data()["writer"];
        let content = data.data()["content"];
        let password = data.data()["password"];

        $("input[id=writer-modal]").attr("value", writer);
        $("input[id=content-modal]").attr("value", content);

        $("#update").click(async function () {
          let inputPassword = $("#password").val();
          if (sha256(inputPassword) == password) {
            const guest = doc(db, "guest", id);
            let writer = $("#writer-modal").val();
            let content = $("#content-modal").val();
            let inform = {
              writer: writer,
              content: content,
            };
            await updateDoc(guest, inform);
            alert("수정되었습니다.");
            window.location.reload();
          } else {
            alert("비밀번호가 일치하지 않습니다.");
          }
        });
      });

      $(".delete-btn").click(async function () {
        let id = this.dataset["id"];
        let data = await getDoc(doc(db, "guest", id));

        let password = data.data()["password"];
        $("#delete").click(async function () {
          let inputPassword = $("#deletePassword").val();
          if (sha256(inputPassword) == password) {
            await deleteDoc(doc(db, "guest", id));
            alert("삭제되었습니다.");
            window.location.reload();
          } else {
            alert("비밀번호가 일치하지 않습니다.");
          }
        });
      });

      $(".button1").click(async function () {
        let writer = $("#writer").val();
        let content = $("#content").val();
        let password = $("#pwd").val();

        let inform = {
          writer: writer,
          content: content,
          password: sha256(password),
          date: new Date(),
        };
        await addDoc(collection(db, "guest"), inform);
        alert("기록완료");
        window.location.reload();
      });

      $("#home").click(async function () {
        window.location.href = "index.html";
      });
    </script>
  </head>

  <body>
    <header>
      <h1 id="home">
        <div>🐾 개발</div>
        <div id="space-text">자국 🐾</div>
      </h1>
      <div class="title">
        <h1 style="font-size: 70px; font-weight: bold">🐾 방명록 🐾</h1>
      </div>
    </header>
    <!--입력폼-->
    <form name="f">
      <div class="input">
        <div>
          <input
            class="writer"
            type="text"
            name="writer"
            id="writer"
            placeholder="닉네임"
          />
          <input
            class="content"
            type="text"
            name="content"
            id="content"
            placeholder="방명록 작성"
          />
          <input
            class="pwd"
            type="password"
            name="pwd"
            id="pwd"
            placeholder="비밀번호"
          />
          <button class="button1" type="button">🐾작성</button>
        </div>
      </div>
    </form>
    <div id="list"></div>

    <!-- 수정 모달 -->
    <div
      class="modal fade"
      id="updateModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">수정하기</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="recipient-name" class="col-form-label"
                  >작성자</label
                >
                <input type="text" class="form-control" id="writer-modal" />
              </div>
            </form>
            <form>
              <div class="mb-3">
                <label for="recipient-name" class="col-form-label">내용</label>
                <input type="text" class="form-control" id="content-modal" />
              </div>
            </form>
            <form>
              <div class="mb-3">
                <label for="recipient-name" class="col-form-label"
                  >비밀번호</label
                >
                <input type="password" class="form-control" id="password" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button type="button" class="btn btn-primary" id="update">
              수정하기
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 삭제 모달 -->
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">
              정말 삭제하시겠습니까?
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="recipient-name" class="col-form-label"
                  >비밀번호</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="deletePassword"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button type="button" class="btn btn-primary" id="delete">
              삭제하기
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- bootstram js 사용 import -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
